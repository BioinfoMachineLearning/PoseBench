# -------------------------------------------------------------------------------------------------------------------------------------
# Following code curated for PoseBench: (https://github.com/BioinfoMachineLearning/PoseBench)
# -------------------------------------------------------------------------------------------------------------------------------------

import logging
import os

import hydra
import rootutils
from Bio import SeqIO
from Bio.PDB import PDBParser
from Bio.PDB.Polypeptide import is_aa
from Bio.Seq import Seq
from Bio.SeqRecord import SeqRecord
from omegaconf import DictConfig, open_dict
from tqdm import tqdm

rootutils.setup_root(__file__, indicator=".project-root", pythonpath=True)
# ------------------------------------------------------------------------------------ #
# the setup_root above is equivalent to:
# - adding project root dir to PYTHONPATH
#       (so you don't need to force user to install project as a package)
#       (necessary before importing any local modules e.g. `from posebench import utils`)
# - setting up PROJECT_ROOT environment variable
#       (which is used as a base for paths in "configs/paths/default.yaml")
#       (this way all filepaths are the same no matter where you run the code)
# - loading environment variables from ".env" in root dir
#
# you can remove it if you:
# 1. either install project as a package or move entry files to project root dir
# 2. set `root_dir` to "." in "configs/paths/default.yaml"
#
# more info: https://github.com/ashleve/rootutils
# ------------------------------------------------------------------------------------ #

logging.basicConfig(format="[%(asctime)s] {%(filename)s:%(lineno)d} %(levelname)s - %(message)s")
logger = logging.getLogger(__name__)

# Constants.
AMINO_ACID_THREE_TO_ONE = {
    "ALA": "A",
    "ARG": "R",
    "ASN": "N",
    "ASP": "D",
    "CYS": "C",
    "GLN": "Q",
    "GLU": "E",
    "GLY": "G",
    "HIS": "H",
    "ILE": "I",
    "LEU": "L",
    "LYS": "K",
    "MET": "M",
    "PHE": "F",
    "PRO": "P",
    "SER": "S",
    "THR": "T",
    "TRP": "W",
    "TYR": "Y",
    "VAL": "V",
}

ID_TO_HHBLITS_AA = {
    0: "A",
    1: "C",  # Also U.
    2: "D",  # Also B.
    3: "E",  # Also Z.
    4: "F",
    5: "G",
    6: "H",
    7: "I",
    8: "K",
    9: "L",
    10: "M",
    11: "N",
    12: "P",
    13: "Q",
    14: "R",
    15: "S",
    16: "T",
    17: "V",
    18: "W",
    19: "Y",
    20: "X",  # Includes J and O.
    21: "-",
}

MODIFIED_TO_NATURAL_AMINO_ACID_RESNAME_MAP = {
    "004": "GLY",
    "02K": "ALA",
    "02L": "ASN",
    "02O": "ALA",
    "02Y": "LEU",
    "03Y": "CYS",
    "04Q": "GLY",
    "04U": "PRO",
    "04V": "PRO",
    "05N": "PRO",
    "05O": "TYR",
    "07O": "CYS",
    "0A0": "ASP",
    "0A1": "TYR",
    "0A2": "LYS",
    "0A8": "CYS",
    "0A9": "ALA",
    "0AA": "VAL",
    "0AB": "VAL",
    "0AC": "GLY",
    "0AF": "TRP",
    "0AH": "SER",
    "0AK": "ASP",
    "0AR": "ARG",
    "0BN": "PHE",
    "0CS": "ALA",
    "0E5": "THR",
    "0EA": "TYR",
    "0FL": "ALA",
    "0LF": "PRO",
    "0PR": "TYR",
    "0QL": "ALA",
    "0RJ": "ALA",
    "0WZ": "TYR",
    "0X9": "ARG",
    "0Y8": "PRO",
    "11Q": "PRO",
    "12X": "PRO",
    "12Y": "PRO",
    "13E": "MET",
    "143": "CYS",
    "19W": "VAL",
    "1C3": "PRO",
    "1IP": "ASN",
    "1MH": "ALA",
    "1OP": "TYR",
    "1PA": "PHE",
    "1PI": "ALA",
    "1TQ": "TRP",
    "1TY": "TYR",
    "1VR": "VAL",
    "1X6": "SER",
    "200": "PHE",
    "22G": "TYR",
    "23F": "PHE",
    "23P": "ALA",
    "28X": "THR",
    "2AG": "ALA",
    "2CO": "CYS",
    "2FM": "MET",
    "2GX": "ALA",
    "2HF": "HIS",
    "2JC": "GLY",
    "2JH": "ALA",
    "2KK": "LYS",
    "2KP": "LYS",
    "2L5": "ALA",
    "2LT": "TYR",
    "2LU": "LEU",
    "2ML": "LEU",
    "2MR": "ARG",
    "2MT": "PRO",
    "2OR": "ARG",
    "2P0": "PRO",
    "2QZ": "THR",
    "2R3": "TYR",
    "2RX": "SER",
    "2SO": "ALA",
    "2TY": "TYR",
    "2VA": "VAL",
    "2XA": "CYS",
    "2YC": "LYS",
    "2YF": "LYS",
    "2YG": "LYS",
    "2ZC": "SER",
    "30V": "CYS",
    "31Q": "CYS",
    "33S": "ALA",
    "33W": "ALA",
    "34E": "VAL",
    "35Y": "ALA",
    "3AH": "HIS",
    "3AR": "ARG",
    "3BY": "PRO",
    "3CF": "PHE",
    "3CT": "TYR",
    "3GA": "ALA",
    "3GL": "GLU",
    "3MD": "ASP",
    "3NF": "TYR",
    "3PM": "SER",
    "3PX": "PRO",
    "3QN": "LYS",
    "3TY": "ALA",
    "3WS": "ALA",
    "3X9": "ALA",
    "3XH": "GLY",
    "3YM": "TYR",
    "3ZL": "LYS",
    "41H": "ALA",
    "41Q": "SER",
    "432": "SER",
    "4AF": "ALA",
    "4AK": "LYS",
    "4AW": "TRP",
    "4BF": "TYR",
    "4CF": "PHE",
    "4CY": "MET",
    "4DP": "TRP",
    "4FB": "PRO",
    "4FW": "TRP",
    "4GJ": "CYS",
    "4HH": "SER",
    "4HJ": "SER",
    "4HT": "TRP",
    "4II": "PHE",
    "4IN": "TRP",
    "4J4": "CYS",
    "4KY": "PRO",
    "4L0": "PRO",
    "4LZ": "TYR",
    "4OG": "TRP",
    "4OU": "ALA",
    "4PH": "PHE",
    "4PQ": "TRP",
    "4QK": "LEU",
    "4SJ": "ALA",
    "4U7": "ALA",
    "51T": "TYR",
    "54C": "TRP",
    "55I": "PHE",
    "56A": "HIS",
    "5AB": "ALA",
    "5CR": "PHE",
    "5CS": "CYS",
    "5CT": "LYS",
    "5CW": "TRP",
    "5DW": "ALA",
    "5FQ": "ALA",
    "5GM": "LEU",
    "5HP": "GLU",
    "5OL": "LYS",
    "5OW": "LYS",
    "5PG": "GLY",
    "5R5": "SER",
    "5T3": "LYS",
    "5VV": "ASN",
    "5X8": "CYS",
    "66C": "ALA",
    "66D": "LEU",
    "66E": "VAL",
    "6BR": "THR",
    "6CL": "LYS",
    "6CV": "ALA",
    "6CW": "TRP",
    "6DU": "ALA",
    "6FL": "LEU",
    "6G4": "LYS",
    "6GL": "ALA",
    "6HN": "LYS",
    "6KM": "CYS",
    "6M6": "CYS",
    "6V1": "CYS",
    "6WK": "CYS",
    "6ZS": "VAL",
    "73N": "ARG",
    "73O": "TYR",
    "73P": "LYS",
    "74P": "LYS",
    "7C9": "SER",
    "7CC": "ASN",
    "7HA": "GLY",
    "7ID": "ASP",
    "7J4": "ASN",
    "7JA": "ILE",
    "7N8": "PHE",
    "7O5": "ALA",
    "7QK": "LYS",
    "7T2": "PHE",
    "7TK": "ASP",
    "7VN": "ALA",
    "7VU": "PHE",
    "7W2": "PHE",
    "81R": "VAL",
    "81S": "VAL",
    "823": "ASN",
    "85G": "GLN",
    "85J": "GLN",
    "85L": "CYS",
    "8RE": "LYS",
    "8SP": "SER",
    "8WY": "LEU",
    "99Y": "ALA",
    "9AT": "THR",
    "9DN": "ASN",
    "9E7": "LYS",
    "9EV": "LEU",
    "9KK": "LEU",
    "9KP": "LYS",
    "9NE": "GLU",
    "9NF": "PHE",
    "9NR": "ARG",
    "9NV": "VAL",
    "9OW": "ALA",
    "9R4": "ALA",
    "9R7": "GLY",
    "9TR": "LYS",
    "9TU": "LYS",
    "9TX": "LYS",
    "9U0": "LYS",
    "9U6": "ALA",
    "9U9": "LYS",
    "9UC": "LYS",
    "9UF": "LYS",
    "9WV": "ALA",
    "A30": "TYR",
    "A3U": "ALA",
    "A5N": "ASN",
    "A66": "LYS",
    "A9D": "PRO",
    "AA3": "ALA",
    "AA4": "ALA",
    "AAR": "ARG",
    "ABA": "ALA",
    "AC5": "LEU",
    "ACB": "ASP",
    "ACL": "ARG",
    "AEA": "CYS",
    "AEI": "ASP",
    "AFA": "ASN",
    "AGM": "ARG",
    "AGQ": "ALA",
    "AGT": "CYS",
    "AHB": "ASN",
    "AHO": "ALA",
    "AHP": "ALA",
    "AIB": "ALA",
    "AKL": "ASP",
    "ALA": "ALA",
    "ALC": "ALA",
    "ALM": "ALA",
    "ALN": "ALA",
    "ALO": "THR",
    "ALS": "ALA",
    "ALT": "ALA",
    "ALY": "LYS",
    "AN8": "ALA",
    "API": "LYS",
    "APK": "LYS",
    "APM": "ALA",
    "AR2": "ARG",
    "AR4": "GLU",
    "ARG": "ARG",
    "ARM": "ARG",
    "ARO": "ARG",
    "ARV": "ARG",
    "AS7": "ASN",
    "ASA": "ASP",
    "ASB": "ASP",
    "ASI": "ASP",
    "ASK": "ASP",
    "ASL": "ASP",
    "ASN": "ASN",
    "ASP": "ASP",
    "ASQ": "ASP",
    "AYA": "ALA",
    "AZH": "ALA",
    "AZK": "LYS",
    "AZS": "SER",
    "AZY": "TYR",
    "B1F": "PHE",
    "B3A": "ALA",
    "B3E": "GLU",
    "B3K": "LYS",
    "B3L": "LEU",
    "B3Q": "GLN",
    "B3U": "HIS",
    "B3X": "ASN",
    "B3Y": "TYR",
    "BB6": "CYS",
    "BB7": "CYS",
    "BB8": "PHE",
    "BB9": "CYS",
    "BBC": "CYS",
    "BCS": "CYS",
    "BFD": "ASP",
    "BG1": "SER",
    "BH2": "ASP",
    "BHD": "ASP",
    "BIF": "PHE",
    "BIL": "ILE",
    "BIU": "ILE",
    "BL2": "LEU",
    "BMT": "THR",
    "BNN": "PHE",
    "BP5": "ALA",
    "BPE": "CYS",
    "BSE": "SER",
    "BTA": "LEU",
    "BTC": "CYS",
    "BTK": "LYS",
    "BTR": "TRP",
    "BUC": "CYS",
    "BUG": "VAL",
    "BWB": "SER",
    "BXT": "SER",
    "BYR": "TYR",
    "C1T": "CYS",
    "C1X": "LYS",
    "C22": "ALA",
    "C3Y": "CYS",
    "C4R": "CYS",
    "C5C": "CYS",
    "C66": "LYS",
    "C6C": "CYS",
    "CAB": "VAL",
    "CAF": "CYS",
    "CAS": "CYS",
    "CAY": "CYS",
    "CCS": "CYS",
    "CDV": "VAL",
    "CEA": "CYS",
    "CG6": "CYS",
    "CGA": "GLU",
    "CGH": "GLY",
    "CGU": "GLU",
    "CGV": "CYS",
    "CHG": "GLY",
    "CHP": "GLY",
    "CIR": "ARG",
    "CLE": "LEU",
    "CLG": "LYS",
    "CLH": "LYS",
    "CME": "CYS",
    "CMH": "CYS",
    "CML": "CYS",
    "CMT": "CYS",
    "CNG": "GLY",
    "CR5": "GLY",
    "CS0": "CYS",
    "CS1": "CYS",
    "CS3": "CYS",
    "CS4": "CYS",
    "CSA": "CYS",
    "CSB": "CYS",
    "CSD": "CYS",
    "CSE": "CYS",
    "CSJ": "CYS",
    "CSK": "CYS",
    "CSO": "CYS",
    "CSP": "CYS",
    "CSR": "CYS",
    "CSS": "CYS",
    "CSU": "CYS",
    "CSW": "CYS",
    "CSX": "CYS",
    "CSZ": "CYS",
    "CTE": "TRP",
    "CTH": "THR",
    "CWD": "ALA",
    "CWR": "SER",
    "CXM": "MET",
    "CY0": "CYS",
    "CY1": "CYS",
    "CY3": "CYS",
    "CY4": "CYS",
    "CYA": "CYS",
    "CYF": "CYS",
    "CYG": "CYS",
    "CYJ": "LYS",
    "CYM": "CYS",
    "CYQ": "CYS",
    "CYR": "CYS",
    "CYS": "CYS",
    "CYW": "CYS",
    "CZ2": "CYS",
    "CZS": "ALA",
    "CZZ": "CYS",
    "D0Q": "TRP",
    "DA2": "ARG",
    "DAB": "ALA",
    "DAH": "PHE",
    "DAM": "ALA",
    "DBS": "SER",
    "DBU": "THR",
    "DBY": "TYR",
    "DBZ": "ALA",
    "DC2": "CYS",
    "DDE": "HIS",
    "DDZ": "ALA",
    "DHA": "SER",
    "DHN": "VAL",
    "DI7": "TYR",
    "DIR": "ARG",
    "DJD": "ALA",
    "DLS": "LYS",
    "DM0": "LYS",
    "DMH": "ASN",
    "DMK": "ASP",
    "DNL": "LYS",
    "DNP": "ALA",
    "DNS": "LYS",
    "DNW": "ALA",
    "DO2": "LEU",
    "DOH": "ASP",
    "DON": "LEU",
    "DPL": "PRO",
    "DPP": "ALA",
    "DPQ": "TYR",
    "DV7": "GLY",
    "DV9": "GLU",
    "DYA": "ASP",
    "DYJ": "PRO",
    "DYS": "CYS",
    "E0Y": "PRO",
    "E95": "TRP",
    "E9C": "TYR",
    "E9M": "TRP",
    "E9V": "HIS",
    "ECC": "GLN",
    "ECX": "CYS",
    "EFC": "CYS",
    "EHP": "PHE",
    "EI4": "ARG",
    "EJA": "CYS",
    "ELY": "LYS",
    "EO2": "LEU",
    "EOE": "PRO",
    "ESB": "TYR",
    "ESC": "MET",
    "EU0": "VAL",
    "EUP": "THR",
    "EW6": "SER",
    "EXA": "LYS",
    "EXL": "TRP",
    "EXY": "LEU",
    "EYS": "CYS",
    "F0G": "ALA",
    "F2F": "PHE",
    "F2Y": "TYR",
    "F7P": "TRP",
    "F7Q": "TYR",
    "F7S": "LEU",
    "F7W": "TRP",
    "FAK": "LYS",
    "FB5": "ALA",
    "FB6": "ALA",
    "FCL": "PHE",
    "FDL": "LYS",
    "FF9": "LYS",
    "FFM": "CYS",
    "FGA": "GLU",
    "FGL": "GLY",
    "FGP": "SER",
    "FH7": "LYS",
    "FHL": "LYS",
    "FHO": "LYS",
    "FL6": "ASP",
    "FLA": "ALA",
    "FLE": "LEU",
    "FLT": "TYR",
    "FME": "MET",
    "FOE": "CYS",
    "FP9": "PRO",
    "FPK": "PRO",
    "FQA": "LYS",
    "FT6": "TRP",
    "FTR": "TRP",
    "FTY": "TYR",
    "FVA": "VAL",
    "FY2": "TYR",
    "FY3": "TYR",
    "FZN": "LYS",
    "G1X": "TYR",
    "G3M": "LYS",
    "G8M": "GLY",
    "GAU": "GLU",
    "GEE": "GLY",
    "GFT": "SER",
    "GGL": "GLU",
    "GHG": "GLN",
    "GL3": "GLY",
    "GLH": "GLN",
    "GLJ": "GLU",
    "GLN": "GLN",
    "GLQ": "GLU",
    "GLU": "GLU",
    "GLY": "GLY",
    "GLZ": "GLY",
    "GMA": "GLU",
    "GNC": "GLN",
    "GPL": "LYS",
    "GQI": "CYS",
    "GSC": "GLY",
    "GSU": "GLU",
    "GT9": "CYS",
    "GVL": "SER",
    "H14": "PHE",
    "H5M": "PRO",
    "HAC": "ALA",
    "HAR": "ARG",
    "HBN": "HIS",
    "HCM": "CYS",
    "HGY": "GLY",
    "HHI": "HIS",
    "HIA": "HIS",
    "HIC": "HIS",
    "HIP": "HIS",
    "HIQ": "HIS",
    "HIS": "HIS",
    "HIX": "ALA",
    "HL2": "LEU",
    "HL5": "LEU",
    "HLU": "LEU",
    "HLX": "LEU",
    "HLY": "LYS",
    "HMR": "ARG",
    "HNC": "CYS",
    "HOO": "HIS",
    "HOX": "ALA",
    "HPC": "PHE",
    "HPE": "PHE",
    "HPQ": "PHE",
    "HQA": "ALA",
    "HR7": "ARG",
    "HRG": "ARG",
    "HRP": "TRP",
    "HS8": "HIS",
    "HS9": "HIS",
    "HSE": "SER",
    "HSK": "HIS",
    "HSL": "SER",
    "HSO": "HIS",
    "HSV": "HIS",
    "HT7": "TRP",
    "HTI": "CYS",
    "HTR": "TRP",
    "HV5": "ALA",
    "HVA": "VAL",
    "HY3": "PRO",
    "HYP": "PRO",
    "HZP": "PRO",
    "I2F": "LYS",
    "I2M": "ILE",
    "I3L": "CYS",
    "I4G": "GLY",
    "I4O": "HIS",
    "I58": "LYS",
    "I7F": "SER",
    "IAE": "PHE",
    "IAM": "ALA",
    "IAR": "ARG",
    "IAS": "ASP",
    "IB9": "TYR",
    "IC0": "GLY",
    "ICY": "CYS",
    "IEL": "LYS",
    "IGL": "GLY",
    "IIL": "ILE",
    "ILE": "ILE",
    "ILG": "GLU",
    "ILX": "ILE",
    "IML": "ILE",
    "IPG": "GLY",
    "IT1": "LYS",
    "IYR": "TYR",
    "IZO": "MET",
    "J2F": "TYR",
    "J3D": "CYS",
    "J8W": "SER",
    "J9A": "GLN",
    "JJJ": "CYS",
    "JJK": "CYS",
    "JJL": "CYS",
    "JKH": "PRO",
    "JLP": "LYS",
    "K1R": "CYS",
    "K5H": "CYS",
    "K5L": "SER",
    "K7K": "SER",
    "KBE": "LYS",
    "KCJ": "ALA",
    "KCR": "LYS",
    "KCX": "LYS",
    "KEO": "LYS",
    "KGC": "LYS",
    "KHB": "LYS",
    "KNB": "ALA",
    "KOR": "MET",
    "KPF": "LYS",
    "KPI": "LYS",
    "KPY": "LYS",
    "KR3": "LYS",
    "KST": "LYS",
    "KYN": "TRP",
    "KYQ": "LYS",
    "L3O": "LEU",
    "L4R": "ALA",
    "LA2": "LYS",
    "LAA": "ASP",
    "LAL": "ALA",
    "LAY": "LEU",
    "LBY": "LYS",
    "LBZ": "LYS",
    "LCK": "LYS",
    "LCX": "LYS",
    "LDH": "LYS",
    "LE1": "VAL",
    "LED": "LEU",
    "LEF": "LEU",
    "LEH": "LEU",
    "LEM": "LEU",
    "LET": "LYS",
    "LEU": "LEU",
    "LGY": "LYS",
    "LLO": "LYS",
    "LLP": "LYS",
    "LLY": "LYS",
    "LLZ": "LYS",
    "LME": "GLU",
    "LMF": "LYS",
    "LMQ": "GLN",
    "LNE": "LEU",
    "LNM": "LEU",
    "LOU": "ALA",
    "LP6": "LYS",
    "LPD": "PRO",
    "LPG": "GLY",
    "LPH": "GLY",
    "LPS": "SER",
    "LSO": "LYS",
    "LT0": "SER",
    "LTR": "TRP",
    "LVG": "GLY",
    "LVN": "VAL",
    "LWI": "PHE",
    "LYF": "LYS",
    "LYH": "LYS",
    "LYM": "LYS",
    "LYN": "LYS",
    "LYO": "LYS",
    "LYR": "LYS",
    "LYS": "LYS",
    "LYU": "LYS",
    "LYV": "GLY",
    "LYX": "LYS",
    "LYZ": "LYS",
    "M0H": "CYS",
    "M2L": "LYS",
    "M2S": "MET",
    "M30": "GLY",
    "M3L": "LYS",
    "MAA": "ALA",
    "MAI": "ARG",
    "MBQ": "TYR",
    "MC1": "SER",
    "MCG": "GLY",
    "MCL": "LYS",
    "MCS": "CYS",
    "MD3": "CYS",
    "MD5": "CYS",
    "MD6": "GLY",
    "MDF": "TYR",
    "ME0": "MET",
    "MEA": "PHE",
    "MEG": "GLU",
    "MEN": "ASN",
    "MEQ": "GLN",
    "MET": "MET",
    "MEU": "GLY",
    "MF3": "MET",
    "MGG": "ARG",
    "MGN": "GLN",
    "MGY": "GLY",
    "MH1": "HIS",
    "MH6": "SER",
    "MHL": "LEU",
    "MHO": "MET",
    "MHS": "HIS",
    "MHU": "PHE",
    "MIR": "SER",
    "MIS": "SER",
    "MK8": "LEU",
    "ML3": "LYS",
    "MLE": "LEU",
    "MLL": "LEU",
    "MLY": "LYS",
    "MLZ": "LYS",
    "MME": "MET",
    "MMO": "ARG",
    "MNL": "LEU",
    "MNV": "VAL",
    "MP8": "PRO",
    "MPH": "MET",
    "MPJ": "MET",
    "MPQ": "GLY",
    "MSA": "GLY",
    "MSE": "MET",
    "MSL": "MET",
    "MSO": "MET",
    "MT2": "MET",
    "MTY": "TYR",
    "MVA": "VAL",
    "MYK": "LYS",
    "N0A": "ALA",
    "N10": "SER",
    "N2C": "CYS",
    "N65": "LYS",
    "N7P": "PRO",
    "N80": "PRO",
    "N9P": "ALA",
    "NA8": "ALA",
    "NAL": "ALA",
    "NAM": "ALA",
    "NB8": "ASN",
    "NBQ": "TYR",
    "NC1": "SER",
    "NCB": "ALA",
    "NCY": "CYS",
    "NEM": "HIS",
    "NEP": "HIS",
    "NFA": "PHE",
    "NIY": "TYR",
    "NKS": "GLY",
    "NLB": "LEU",
    "NLE": "LEU",
    "NLN": "LEU",
    "NLO": "LEU",
    "NLP": "LEU",
    "NLQ": "GLN",
    "NLW": "LEU",
    "NLY": "GLY",
    "NMC": "GLY",
    "NMM": "ARG",
    "NNH": "ARG",
    "NOT": "LEU",
    "NPH": "CYS",
    "NPI": "ALA",
    "NRG": "ARG",
    "NSK": "LYS",
    "NTR": "TYR",
    "NTY": "TYR",
    "NVA": "VAL",
    "NWD": "ALA",
    "NYB": "CYS",
    "NYS": "CYS",
    "NZC": "THR",
    "NZH": "HIS",
    "O2E": "SER",
    "O6H": "TRP",
    "O7A": "THR",
    "O7D": "TRP",
    "OAS": "SER",
    "OBS": "LYS",
    "OCS": "CYS",
    "OCY": "CYS",
    "OGC": "ALA",
    "OHI": "HIS",
    "OHS": "ASP",
    "OJY": "VAL",
    "OLD": "HIS",
    "OLT": "THR",
    "OLZ": "SER",
    "OMH": "SER",
    "OMT": "MET",
    "OMX": "TYR",
    "OMY": "TYR",
    "ONH": "ALA",
    "ONL": "LEU",
    "ORN": "ALA",
    "ORQ": "ARG",
    "OSE": "SER",
    "OTH": "THR",
    "OTY": "TYR",
    "OXX": "ASP",
    "OYL": "HIS",
    "OZW": "PHE",
    "P1L": "CYS",
    "P2Q": "TYR",
    "P2Y": "PRO",
    "P3Q": "TYR",
    "P9S": "CYS",
    "PAQ": "TYR",
    "PAS": "ASP",
    "PAT": "TRP",
    "PBB": "CYS",
    "PBF": "PHE",
    "PCA": "GLN",
    "PCC": "PRO",
    "PCS": "PHE",
    "PDL": "ALA",
    "PE1": "LYS",
    "PEC": "CYS",
    "PF5": "PHE",
    "PFF": "PHE",
    "PG1": "SER",
    "PGY": "GLY",
    "PH6": "PRO",
    "PH8": "VAL",
    "PHA": "PHE",
    "PHD": "ASP",
    "PHE": "PHE",
    "PHI": "PHE",
    "PHL": "PHE",
    "PJ3": "HIS",
    "PLJ": "PRO",
    "PM3": "PHE",
    "POK": "ARG",
    "POM": "PRO",
    "PPN": "PHE",
    "PR3": "CYS",
    "PR4": "PRO",
    "PR7": "PRO",
    "PRK": "LYS",
    "PRO": "PRO",
    "PRR": "ALA",
    "PRS": "PRO",
    "PRV": "GLY",
    "PSH": "HIS",
    "PSW": "ALA",
    "PTH": "TYR",
    "PTM": "TYR",
    "PTR": "TYR",
    "PVH": "HIS",
    "PXU": "PRO",
    "PYA": "ALA",
    "PYH": "LYS",
    "PYL": "LYS",
    "PYX": "CYS",
    "Q2E": "TRP",
    "Q3P": "LYS",
    "Q75": "MET",
    "Q78": "PHE",
    "Q8X": "CYS",
    "QAC": "ALA",
    "QCI": "GLN",
    "QCS": "CYS",
    "QIL": "ILE",
    "QM8": "LEU",
    "QMB": "VAL",
    "QMM": "GLN",
    "QNQ": "CYS",
    "QNT": "CYS",
    "QNW": "CYS",
    "QNY": "THR",
    "QO2": "CYS",
    "QO5": "CYS",
    "QO8": "CYS",
    "QPA": "CYS",
    "QPH": "PHE",
    "QQ8": "GLN",
    "QVA": "CYS",
    "QX7": "ALA",
    "R0K": "GLU",
    "R1A": "CYS",
    "R2T": "GLN",
    "R4K": "TRP",
    "RE0": "TRP",
    "RE3": "TRP",
    "RF9": "LYS",
    "RGL": "ARG",
    "RGP": "GLU",
    "RON": "VAL",
    "RPI": "ARG",
    "RT0": "PRO",
    "RVJ": "ALA",
    "RVX": "SER",
    "RX9": "ILE",
    "RXL": "VAL",
    "RZ4": "SER",
    "S0R": "LEU",
    "S12": "SER",
    "S1H": "SER",
    "S2C": "CYS",
    "S2P": "ALA",
    "SAC": "SER",
    "SAH": "CYS",
    "SAO": "CYS",
    "SAR": "GLY",
    "SBL": "SER",
    "SCH": "CYS",
    "SCS": "CYS",
    "SCY": "CYS",
    "SD2": "MET",
    "SD4": "ASN",
    "SDP": "SER",
    "SEB": "SER",
    "SEC": "CYS",
    "SEE": "SER",
    "SEG": "ALA",
    "SEL": "SER",
    "SEM": "SER",
    "SEN": "SER",
    "SEP": "SER",
    "SER": "SER",
    "SET": "SER",
    "SFE": "ALA",
    "SGB": "SER",
    "SHC": "CYS",
    "SHP": "GLY",
    "SHR": "LYS",
    "SIB": "CYS",
    "SKG": "ILE",
    "SKH": "LYS",
    "SKJ": "LEU",
    "SLL": "LYS",
    "SLZ": "LYS",
    "SMC": "CYS",
    "SME": "MET",
    "SMF": "PHE",
    "SNC": "CYS",
    "SNK": "HIS",
    "SNN": "ASN",
    "SOC": "CYS",
    "SOY": "SER",
    "SRZ": "SER",
    "STY": "TYR",
    "SUB": "ALA",
    "SUN": "SER",
    "SVA": "SER",
    "SVV": "SER",
    "SVW": "SER",
    "SVX": "SER",
    "SVY": "SER",
    "SVZ": "SER",
    "SWW": "SER",
    "SXE": "SER",
    "SYS": "ALA",
    "SZF": "TRP",
    "T0I": "TYR",
    "T11": "PHE",
    "T3R": "LEU",
    "T66": "LYS",
    "T8L": "THR",
    "T9E": "THR",
    "TAV": "ASP",
    "TBG": "VAL",
    "TBM": "THR",
    "TCQ": "TYR",
    "TCR": "TRP",
    "TEF": "ALA",
    "TFQ": "PHE",
    "TGH": "TRP",
    "TH5": "THR",
    "TH6": "THR",
    "THC": "THR",
    "THO": "THR",
    "THR": "THR",
    "THZ": "ARG",
    "TIH": "ALA",
    "TIS": "SER",
    "TLY": "LYS",
    "TMB": "THR",
    "TMD": "THR",
    "TNB": "CYS",
    "TNQ": "TRP",
    "TNR": "SER",
    "TOQ": "TRP",
    "TOX": "TRP",
    "TPJ": "PRO",
    "TPK": "PRO",
    "TPL": "TRP",
    "TPO": "THR",
    "TPQ": "TYR",
    "TQI": "TRP",
    "TQQ": "TRP",
    "TQZ": "CYS",
    "TRF": "TRP",
    "TRG": "LYS",
    "TRN": "TRP",
    "TRO": "TRP",
    "TRP": "TRP",
    "TRQ": "TRP",
    "TRW": "TRP",
    "TRX": "TRP",
    "TRY": "TRP",
    "TS9": "ILE",
    "TSQ": "ALA",
    "TST": "LEU",
    "TSY": "CYS",
    "TTQ": "TRP",
    "TTS": "TYR",
    "TXY": "TYR",
    "TY1": "TYR",
    "TY2": "TYR",
    "TY3": "TYR",
    "TY5": "TYR",
    "TY8": "ALA",
    "TY9": "ALA",
    "TYB": "TYR",
    "TYE": "TYR",
    "TYI": "TYR",
    "TYJ": "TYR",
    "TYN": "TYR",
    "TYO": "TYR",
    "TYQ": "TYR",
    "TYR": "TYR",
    "TYS": "TYR",
    "TYT": "TYR",
    "TYX": "CYS",
    "TYY": "TYR",
    "U2X": "TYR",
    "U3X": "ALA",
    "UF0": "SER",
    "UGY": "GLY",
    "UKD": "ALA",
    "UKY": "ALA",
    "UM2": "ALA",
    "UMA": "ALA",
    "UOX": "ALA",
    "UXY": "LYS",
    "V44": "CYS",
    "V61": "PHE",
    "V6W": "TRP",
    "VAD": "VAL",
    "VAF": "VAL",
    "VAH": "VAL",
    "VAL": "VAL",
    "VB1": "LYS",
    "VH0": "PRO",
    "VHF": "GLU",
    "VI3": "CYS",
    "VLM": "VAL",
    "VOL": "VAL",
    "VPV": "LYS",
    "VVK": "ALA",
    "WFP": "ALA",
    "WLU": "LEU",
    "WPA": "PHE",
    "WRP": "TRP",
    "WVL": "VAL",
    "WYK": "ARG",
    "WZJ": "ILE",
    "X2W": "GLU",
    "X60": "VAL",
    "XA6": "PHE",
    "XCN": "CYS",
    "XPL": "LYS",
    "XPR": "PRO",
    "XSN": "ASN",
    "XX1": "LYS",
    "Y1V": "LEU",
    "Y57": "LYS",
    "YCM": "CYS",
    "YHA": "LYS",
    "YNM": "TYR",
    "YOF": "TYR",
    "YPR": "PRO",
    "YPZ": "ALA",
    "YTH": "THR",
    "Z01": "ALA",
    "Z3E": "THR",
    "Z70": "HIS",
    "ZAI": "LYS",
    "ZBZ": "CYS",
    "ZCL": "PHE",
    "ZDJ": "TYR",
    "ZIQ": "TRP",
    "ZNY": "PRO",
    "ZT6": "TYR",
    "ZU0": "THR",
    "ZV4": "PHE",
    "ZYJ": "PRO",
    "ZYK": "PRO",
    "ZZD": "CYS",
    "ZZJ": "ALA",
    "ZZU": "ARG",
}


@hydra.main(
    version_base="1.3",
    config_path="../../../configs/data/components",
    config_name="protein_fasta_preparation.yaml",
)
def main(cfg: DictConfig):
    """Prepare reference FASTA sequence file for protein chains in the dataset."""
    if cfg.dataset not in ["posebusters_benchmark", "astex_diverse", "dockgen", "casp15"]:
        raise ValueError(f"Dataset {cfg.dataset} is not supported.")

    # load ID subset if requested
    pdb_ids = None
    if cfg.dataset == "posebusters_benchmark" and cfg.posebusters_ccd_ids_filepath is not None:
        assert os.path.exists(
            cfg.posebusters_ccd_ids_filepath
        ), f"Invalid CCD IDs file path for PoseBusters Benchmark: {os.path.exists(cfg.posebusters_ccd_ids_filepath)}."
        with open(cfg.posebusters_ccd_ids_filepath) as f:
            pdb_ids = set(f.read().splitlines())
    elif cfg.dataset == "dockgen" and cfg.dockgen_test_ids_filepath is not None:
        assert os.path.exists(
            cfg.dockgen_test_ids_filepath
        ), f"Invalid test IDs file path for DockGen: {os.path.exists(cfg.dockgen_test_ids_filepath)}."
        with open(cfg.dockgen_test_ids_filepath) as f:
            pdb_ids = {line.replace(" ", "-") for line in f.read().splitlines()}

    data_dir = [
        name
        for name in os.listdir(cfg.data_dir)
        if os.path.isdir(os.path.join(cfg.data_dir, name)) and (pdb_ids is None or name in pdb_ids)
    ]

    if cfg.dataset == "casp15":
        with open_dict(cfg):
            cfg.data_dir = os.path.join(cfg.data_dir, "targets")

        data_dir = [name for name in os.listdir(cfg.data_dir) if name.endswith("_lig.pdb")]

    entries = []
    for name in tqdm(
        data_dir,
        desc="Processing reference PDB file for reference FASTA sequence file generation",
    ):
        data_subdir = os.path.join(cfg.data_dir, name)
        pdb_filepath = os.path.join(data_subdir, f"{name}_protein.pdb")

        if cfg.dataset == "casp15":
            pdb_filepath = os.path.dirname(pdb_filepath)

        if not os.path.exists(pdb_filepath):
            # NOTE: this supports the DockGen dataset's file formatting
            pdb_filepath = os.path.join(data_subdir, f"{name.split('_')[0]}_processed.pdb")
        if not os.path.exists(pdb_filepath):
            logger.warning(f"Skipping {name} as PDB file not found.")
            continue

        # load the first model of the PDB file
        biopython_parser = PDBParser(QUIET=True)
        models = biopython_parser.get_structure("random_id", pdb_filepath)
        structure = models[0]

        structure_seqs = []
        for chain in structure:
            aa_residues = [residue for residue in chain if is_aa(residue)]
            if cfg.dataset == "casp15":
                # NOTE: for CASP15, we exclude modified (hetero) amino acid residues serving as ligands
                name = name.split("_")[0]
                aa_residues = [residue for residue in aa_residues if residue.id[0] == " "]
            aa_residue_names = [
                MODIFIED_TO_NATURAL_AMINO_ACID_RESNAME_MAP[residue.resname]
                for residue in aa_residues
                if residue.resname in MODIFIED_TO_NATURAL_AMINO_ACID_RESNAME_MAP
            ]
            seq = "".join(
                AMINO_ACID_THREE_TO_ONE.get(resname, "X") for resname in aa_residue_names
            )

            # skip if not a protein chain
            if not seq:
                continue

            structure_seqs.append((f"{name}_chain_{chain.id}", seq))

        entries.extend(structure_seqs)

    records = []
    for seq_id, seq in entries:
        record = SeqRecord(Seq(seq), id=str(seq_id))
        record.description = ""
        records.append(record)
    SeqIO.write(records, cfg.out_file, "fasta")


if __name__ == "__main__":
    main()
